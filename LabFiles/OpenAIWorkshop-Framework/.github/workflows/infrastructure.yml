name: OpenAI Workshop Infrastructure Deployment and Test

on:
  workflow_call:
    inputs:
      environment:
        type: string
        required: true
      iac-tool:
        type: string
        required: false
        default: tf
    outputs:
      backend_endpoint:
        description: "Backend API endpoint URL"
        value: ${{ jobs.tf.outputs.BACKEND_API_ENDPOINT }}
      mcp_endpoint:
        description: "MCP service endpoint URL"
        value: ${{ jobs.tf.outputs.MCP_ACA_URL }}
      model_endpoint:
        description: "Model endpoint URL"
        value: ${{ jobs.tf.outputs.MODEL_ENDPOINT }}

  workflow_dispatch:
    inputs:
      environment:
        description: Target environment
        default: dev
        required: true
      iac-tool:
        description: "Choose your infrastructure as code tool"
        type: choice
        options:
        - tf
        - bicep
        default: tf
        required: true
        

jobs:
  tf:
    name: Terraform Deployment
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    if: ${{ (github.event_name == 'workflow_dispatch' && github.event.inputs.iac-tool || 'tf') == 'tf' }}
    permissions:
      id-token: write
      contents: read
    outputs:
      MODEL_ENDPOINT: ${{ steps.terraform.outputs.MODEL_ENDPOINT }}
      MCP_ACA_URL: ${{ steps.terraform.outputs.MCP_ACA_URL }}
      BACKEND_API_ENDPOINT: ${{ steps.terraform.outputs.BACKEND_API_ENDPOINT }}
      KEY_VAULT_NAME: ${{ steps.terraform.outputs.KEY_VAULT_NAME }}

    steps:
      - uses: actions/checkout@v6

      - name: Azure OIDC Login
        uses: azure/login@v2
        with:
          client-id: ${{ vars.AZURE_CLIENT_ID }}
          tenant-id: ${{ vars.AZURE_TENANT_ID }}
          subscription-id: ${{ vars.AZURE_SUBSCRIPTION_ID }}

      - name: Terraform Setup
        uses: hashicorp/setup-terraform@v3

      - name: Sanitize environment name for state key
        id: sanitize
        run: |
          # Replace / and other invalid chars with - for valid Azure blob name
          ENV="${{ inputs.environment }}"
          SAFE_ENV=$(echo "$ENV" | sed 's/[^a-zA-Z0-9._-]/-/g')
          echo "env=$SAFE_ENV" >> $GITHUB_OUTPUT

      - name: Terraform Init/Plan/Apply
        id: terraform
        run: |
          cd infra/terraform
          export ARM_USE_OIDC=true
          export ARM_CLIENT_ID="${{ vars.AZURE_CLIENT_ID }}"
          export ARM_TENANT_ID="${{ vars.AZURE_TENANT_ID }}"
          export ARM_SUBSCRIPTION_ID="${{ vars.AZURE_SUBSCRIPTION_ID }}"

          # Common -var flags used by plan and import
          TF_VARS=(
            -var project_name=${{ github.event.repository.name }}
            -var environment=${{ inputs.environment }}
            -var tenant_id=${{ vars.AZURE_TENANT_ID }}
            -var subscription_id=${{ vars.AZURE_SUBSCRIPTION_ID }}
            -var acr_name=${{ vars.ACR_NAME }}
            -var location=${{ vars.AZ_REGION }}
            -var docker_image_mcp=${{ vars.DOCKER_IMAGE_MCP }}
            -var docker_image_backend=${{ vars.DOCKER_IMAGE_BACKEND }}
            -var iteration=${{ vars.ITERATION }}
          )

          terraform init -backend-config="resource_group_name=${TFSTATE_RG}" \
                         -backend-config="key=${TFSTATE_KEY}" -backend-config="storage_account_name=${TFSTATE_ACCOUNT}" \
                         -backend-config="container_name=${TFSTATE_CONTAINER}" -backend-config="use_oidc=true" -backend-config="use_azuread_auth=true"

          # ‚îÄ‚îÄ Apply with auto-import on "already exists" errors ‚îÄ‚îÄ
          # If a prior run partially created resources but crashed before recording
          # them in state, Terraform will fail with "already exists". This loop
          # detects those errors, auto-imports the orphaned resources, and retries.
          MAX_ATTEMPTS=3
          for attempt in $(seq 1 $MAX_ATTEMPTS); do
            echo "üîÑ Terraform apply attempt $attempt/$MAX_ATTEMPTS"

            terraform plan -out tfplan "${TF_VARS[@]}"

            if terraform apply -auto-approve tfplan 2>&1 | tee /tmp/tf_apply.log; then
              echo "‚úÖ Terraform apply succeeded"
              break
            fi

            # Check if the failure is due to "already exists" errors
            if ! grep -q "already exists" /tmp/tf_apply.log; then
              echo "‚ùå Terraform failed with a non-import error"
              cat /tmp/tf_apply.log
              exit 1
            fi

            if [ "$attempt" -eq "$MAX_ATTEMPTS" ]; then
              echo "‚ùå Terraform failed after $MAX_ATTEMPTS attempts"
              cat /tmp/tf_apply.log
              exit 1
            fi

            echo "‚ö†Ô∏è Detected 'already exists' errors ‚Äî auto-importing orphaned resources..."

            # Parse error output: extract terraform address and Azure resource ID pairs
            # Error format:  with azurerm_container_app.mcp,
            # followed by:   a resource with the ID "/.../containerApps/ca-mcp-002" already exists
            while IFS= read -r line; do
              # Extract the TF resource address (e.g. azurerm_container_app.mcp)
              tf_addr=$(echo "$line" | grep -oP 'with \K[a-zA-Z0-9_.]+(?=,)')
              # Extract the Azure resource ID
              azure_id=$(echo "$line" | grep -oP 'the ID "\K[^"]+')

              if [ -n "$tf_addr" ] && [ -n "$azure_id" ]; then
                echo "  üì• Importing $tf_addr ‚Üí $azure_id"
                terraform import "${TF_VARS[@]}" "$tf_addr" "$azure_id" || true
              fi
            done < <(
              # Combine consecutive lines so address + ID are on the same logical line
              cat /tmp/tf_apply.log | tr '\n' '¬ß' | sed 's/¬ß‚îÇ/‚îÇ/g' | tr '¬ß' '\n' | grep "already exists"
            )

            echo "üîÅ Retrying terraform apply..."
          done

          output=$(terraform output -raw openai_endpoint 2>/dev/null || true)
          echo "MODEL_ENDPOINT=$output" >> $GITHUB_OUTPUT
          mcp_aca_url=$(terraform output -raw mcp_aca_url 2>/dev/null || true)
          echo "MCP_ACA_URL=$mcp_aca_url" >> $GITHUB_OUTPUT
          be_aca_url=$(terraform output -raw be_aca_url 2>/dev/null || true)
          echo "BACKEND_API_ENDPOINT=$be_aca_url" >> $GITHUB_OUTPUT

        env:
          TFSTATE_RG: ${{ vars.TFSTATE_RG }}
          TFSTATE_ACCOUNT: ${{ vars.TFSTATE_ACCOUNT }}
          TFSTATE_CONTAINER: ${{ vars.TFSTATE_CONTAINER }}
          # Use environment name for state key ‚Äî each env gets its own TF state
          TFSTATE_KEY: "${{ github.event.repository.name }}-${{ steps.sanitize.outputs.env }}.tfstate"

  bicep:
      runs-on: ubuntu-latest
      environment: ${{ inputs.environment }}
      if: ${{ (github.event_name == 'workflow_dispatch' && github.event.inputs.iac-tool || 'tf') == 'bicep' }}
      permissions:
        id-token: write
        contents: read    

      steps:
        - uses: actions/checkout@v6

        - name: Azure OIDC Login
          uses: azure/login@v2
          with:
            client-id: ${{ vars.AZURE_CLIENT_ID }}
            tenant-id: ${{ vars.AZURE_TENANT_ID }}
            subscription-id: ${{ vars.AZURE_SUBSCRIPTION_ID }}

        - name: Bicep Install
          uses: azure/setup-bicep@v1
          with:
            version: 'latest'

        - name: Bicep Build and Deploy
          run: |
            cd infra/bicep
            az deployment group create \
              --resource-group ${{ vars.BICEP_DEPLOYMENT_RG }} \
              --template-file main.bicep \
              --parameters projectName=${{ github.event.repository.name }} \
              --parameters location=${{ vars.AZ_REGION }} \
              --parameters acrName=${{ vars.ACR_NAME }}   
          env:
            BICEP_DEPLOYMENT_RG: ${{ vars.BICEP_DEPLOYMENT_RG }}

  # NOTE: Integration tests are run from orchestrate.yml AFTER containers are deployed
  # Do not add test jobs here - tests need to run after update-containers completes